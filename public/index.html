<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Request</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
      }
    </style>
  </head>
  <body>
    <img
      src="/stackseekers.jpg"
      alt="Stackseekers Cover"
      class="w-full block shadow object-cover h-48 md:h-64"
    />
    <div class="mx-auto bg-gray-50 p-8 rounded-lg">
      <h1 class="text-4xl font-bold text-black-600">Service Request</h1>
      <form id="service-form">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <div>
            <h3 class="mt-6 text-lg font-semibold">Product Details</h3>
            <div style="margin-top: 12px">
              <label
                for="product"
                class="block text-sm font-medium text-gray-700"
                >Product</label
              >
              <input
                id="product"
                name="product"
                type="text"
                required
                placeholder="e.g. Washing Machine Model X"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div style="margin-top: 12px">
              <label
                for="serial"
                class="block text-sm font-medium text-gray-700"
                >Serial Number</label
              >
              <input
                id="serial"
                name="serial"
                type="text"
                required
                placeholder="e.g. SN12345678"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div style="margin-top: 12px">
              <label
                for="purchaseDate"
                class="block text-sm font-medium text-gray-700"
                >Purchase Date</label
              >
              <input
                id="purchaseDate"
                name="purchaseDate"
                type="date"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>
          <div>
            <h3 class="mt-6 text-lg font-semibold">Product Symptom</h3>
            <div style="margin-top: 12px">
              <label
                for="service"
                class="block text-sm font-medium text-gray-700"
                >Issue Type</label
              >
              <select
                id="service"
                name="service"
                required
                class="mt-1 block w-full rounded-md border border-gray-300 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="" disabled selected>
                  Loading issue types...
                </option>
              </select>
              <div
                id="issue-type-status"
                class="text-sm text-gray-500 mt-1"
                style="display: none"
              ></div>
              <button
                id="retry-issue-types"
                type="button"
                class="text-sm text-blue-600 hover:text-blue-800 underline mt-1"
                style="display: none"
                onclick="loadIssueTypes()"
              >
                Retry loading issue types
              </button>
            </div>
            <div style="margin-top: 12px">
              <label
                for="details"
                class="block text-sm font-medium text-gray-700"
                >Issue Details</label
              >
              <textarea
                id="details"
                name="details"
                required
                placeholder="Describe the problem"
                rows="2"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              ></textarea>
            </div>
            <!-- Enhanced drag-and-drop image upload section -->
            <div style="margin-top: 12px">
              <label
                for="image"
                class="block text-sm font-medium text-gray-700"
              >
                Upload Images
              </label>
              <!-- Drop Zone -->
              <div
                id="drop-zone"
                class="flex flex-col items-center justify-center w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition"
              >
                <p class="text-gray-500 text-sm">
                  Drag & drop your images here
                </p>
                <p class="text-gray-400 text-xs">or click to select</p>
                <input
                  id="image"
                  name="image"
                  type="file"
                  accept="image/*"
                  capture="environment"
                  multiple
                  aria-describedby="image-help image-error"
                  class="hidden"
                />
              </div>
              <div id="image-help" class="text-sm text-gray-500 mt-2">
                Supported formats: JPG, PNG, GIF, WebP, SVG. Max file size: 5MB.
                Max files: 10. Images are uploaded directly to Notion.
              </div>
              <!-- Error text -->
              <div
                id="image-error"
                class="error-text text-red-500 text-sm mt-1"
                style="display: none"
              ></div>
              <!-- File preview area -->
              <div
                id="file-preview"
                class="file-preview grid grid-cols-4 gap-2 mt-4"
                style="display: none"
              ></div>
              <!-- Upload progress -->
              <div
                id="upload-progress"
                class="upload-progress mt-3 w-full bg-gray-200 rounded-full h-2.5"
                style="display: none"
              >
                <div
                  class="progress-bar bg-blue-600 h-2.5 rounded-full"
                  id="progress-bar"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="mt-6 text-lg font-semibold">Engineer Schedule</h3>
            <div style="margin-top: 12px">
              <label
                for="scheduleDate"
                class="block text-sm font-medium text-gray-700"
                >Choose a preferable date for scheduling Engineer visit (future
                dates only)</label
              >
              <input
                id="scheduleDate"
                name="scheduleDate"
                type="date"
                min=""
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <div
                id="schedule-date-status"
                class="text-sm text-gray-500 mt-1"
                style="display: none"
              ></div>
            </div>
            <h3 class="mt-6 text-lg font-semibold">Contact Information</h3>
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700"
                >Full Name</label
              >
              <input
                id="name"
                name="name"
                type="text"
                required
                placeholder="Your full name"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <div style="margin-top: 12px">
              <label for="email" class="block text-sm font-medium text-gray-700"
                >Email</label
              >
              <input
                id="email"
                name="email"
                type="email"
                required
                placeholder="you@example.com"
                class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>
        </div>
        <div class="mt-8">
          <button
            id="submitBtn"
            type="submit"
            class="bg-black hover:bg-black-600 text-white font-medium py-2 px-4 rounded disabled:bg-gray-400"
          >
            Submit Request
          </button>
        </div>
      </form>
      <div id="result" class="status" style="display: none"></div>
    </div>

    <script>
      // Use Netlify system environment variable or fallback to current origin
      const BASE_URL = window.location.origin + "/";

      // File upload constants based on Notion API limits
      const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB for free workspaces
      const MAX_FILES = 10;
      const SUPPORTED_TYPES = [
        "image/jpeg",
        "image/png",
        "image/gif",
        "image/webp",
        "image/svg+xml",
      ];

      const form = document.getElementById("service-form");
      const resultEl = document.getElementById("result");
      const submitBtn = document.getElementById("submitBtn");
      const imageInput = document.getElementById("image");
      const filePreview = document.getElementById("file-preview");
      const uploadProgress = document.getElementById("upload-progress");
      const progressBar = document.getElementById("progress-bar");
      const imageError = document.getElementById("image-error");
      const dropZone = document.getElementById("drop-zone");

      // Function to fetch and populate issue types from Notion
      async function loadIssueTypes() {
        const serviceSelect = document.getElementById("service");
        const statusElement = document.getElementById("issue-type-status");

        try {
          // Show loading state
          serviceSelect.innerHTML =
            '<option value="" disabled selected>Loading issue types...</option>';
          serviceSelect.disabled = true;
          statusElement.textContent = "Loading issue types from Notion...";
          statusElement.style.display = "block";
          statusElement.className = "text-sm text-blue-600 mt-1";

          const response = await fetch(
            `${BASE_URL}.netlify/functions/get-issue-types`
          );
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.success && data.issueTypes && data.issueTypes.length > 0) {
            // Clear existing options
            serviceSelect.innerHTML =
              '<option value="" disabled selected>Select issue</option>';

            // Add options from Notion
            data.issueTypes.forEach((issueType) => {
              const option = document.createElement("option");
              option.value = issueType.name;
              option.textContent = issueType.name;
              serviceSelect.appendChild(option);
            });

            // Show success status
            statusElement.textContent = `✓ Loaded ${data.issueTypes.length} issue types`;
            statusElement.className = "text-sm text-green-600 mt-1";

            // Hide retry button on success
            document.getElementById("retry-issue-types").style.display = "none";

            console.log(
              `Loaded ${data.issueTypes.length} issue types:`,
              data.issueTypes
            );
          } else {
            throw new Error(data.error || "No issue types found in database");
          }
        } catch (error) {
          console.error("Error loading issue types:", error);

          // Show error state
          serviceSelect.innerHTML =
            '<option value="" disabled selected>Error loading issue types</option>';
          statusElement.textContent = `⚠ Error: ${error.message}. Retrying with fallback options...`;
          statusElement.className = "text-sm text-orange-600 mt-1";

          // Show retry button
          document.getElementById("retry-issue-types").style.display = "inline";

          // Fallback to default options after a delay
          setTimeout(() => {
            serviceSelect.innerHTML = `
              <option value="" disabled selected>Select issue (using fallback options)</option>
              <option value="Won't Turn On">Won't Turn On</option>
              <option value="Makes Strange Noise">Makes Strange Noise</option>
              <option value="Physical Damage">Physical Damage</option>
              <option value="Software Problem">Software Problem</option>
              <option value="Missing Parts">Missing Parts</option>
              <option value="Product Leaking">Product Leaking</option>
              <option value="Display Issues">Display Issues</option>
              <option value="Connection Problems">Connection Problems</option>
              <option value="Battery Problems">Battery Problems</option>
              <option value="Broken Accessory">Broken Accessory</option>
              <option value="Other">Other</option>
            `;
            serviceSelect.disabled = false;
            statusElement.textContent = "✓ Using fallback issue type options";
            statusElement.className = "text-sm text-gray-600 mt-1";
          }, 2000);

          return;
        }

        // Enable the select field
        serviceSelect.disabled = false;
      }

      // Function to set minimum date for schedule date field
      function setScheduleDateMin() {
        const scheduleDateInput = document.getElementById("scheduleDate");
        const today = new Date().toISOString().split("T")[0];
        scheduleDateInput.min = today;

        // Add change event listener for validation
        scheduleDateInput.addEventListener("change", validateScheduleDate);

        // Also add input event listener to catch manual typing
        scheduleDateInput.addEventListener("input", validateScheduleDate);

        // Update minimum date every day at midnight
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);

        const timeUntilMidnight = tomorrow - now;

        // Set a timer to update the minimum date at midnight
        setTimeout(() => {
          setScheduleDateMin();
          // Then update every 24 hours
          setInterval(setScheduleDateMin, 24 * 60 * 60 * 1000);
        }, timeUntilMidnight);
      }

      // Function to validate schedule date
      function validateScheduleDate() {
        const scheduleDateInput = document.getElementById("scheduleDate");
        const statusElement = document.getElementById("schedule-date-status");

        if (!scheduleDateInput.value) {
          statusElement.style.display = "none";
          scheduleDateInput.setCustomValidity("");
          return;
        }

        const selectedDate = new Date(scheduleDateInput.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison

        if (selectedDate < today) {
          statusElement.textContent =
            "⚠ Please select a future date for engineer scheduling";
          statusElement.className = "text-sm text-red-600 mt-1";
          statusElement.style.display = "block";
          scheduleDateInput.setCustomValidity("Please select a future date");

          // Clear the invalid date
          scheduleDateInput.value = "";
        } else {
          statusElement.textContent = "✓ Date selected for engineer scheduling";
          statusElement.className = "text-sm text-green-600 mt-1";
          statusElement.style.display = "block";
          scheduleDateInput.setCustomValidity("");
        }
      }

      // Load issue types when page loads
      loadIssueTypes();

      // Set up schedule date validation when page loads
      setScheduleDateMin();

      // Handle click to open file picker
      dropZone.addEventListener("click", () => imageInput.click());

      // Highlight drop area on drag over
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("bg-blue-50", "border-blue-400");
      });

      // Remove highlight on drag leave
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("bg-blue-50", "border-blue-400");
      });

      // Handle file drop
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("bg-blue-50", "border-blue-400");
        handleFiles(e.dataTransfer.files);
      });

      // Handle file selection from click
      imageInput.addEventListener("change", (e) => {
        handleFiles(e.target.files);
      });

      // Common file handling logic
      function handleFiles(files) {
        const incomingFiles = Array.from(files);
        hideError();

        if (incomingFiles.length > MAX_FILES) {
          showError(`Maximum ${MAX_FILES} files allowed.`);
          return;
        }

        const validFiles = [];
        const errors = [];

        incomingFiles.forEach((file) => {
          const error = validateFile(file);
          if (error) {
            errors.push(error);
          } else {
            validFiles.push(file);
          }
        });

        if (errors.length > 0) {
          showError(errors.join("\n"));
        }

        selectedFiles = validFiles;
        updateFilePreview();
        updateFileInput();
      }

      let selectedFiles = [];

      function showResult(message, ok) {
        resultEl.style.display = "block";
        resultEl.style.background = ok ? "#d4edda" : "#f8d7da";
        resultEl.style.color = ok ? "#155724" : "#721c24";
        resultEl.textContent = message;
      }

      function showError(message) {
        imageError.textContent = message;
        imageError.style.display = "block";
      }

      function hideError() {
        imageError.style.display = "none";
      }

      function validateFile(file) {
        // Check file size
        if (file.size > MAX_FILE_SIZE) {
          return `File "${file.name}" is too large. Maximum size is 5MB.`;
        }

        // Check file type
        if (!SUPPORTED_TYPES.includes(file.type)) {
          return `File "${file.name}" is not a supported image format.`;
        }

        return null;
      }

      function createFilePreview(file, index) {
        const fileItem = document.createElement("div");
        fileItem.className = "file-item";

        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.alt = `Preview of ${file.name}`;

        const removeBtn = document.createElement("button");
        removeBtn.className = "file-remove";
        removeBtn.innerHTML = "×";
        removeBtn.setAttribute("aria-label", `Remove ${file.name}`);
        removeBtn.onclick = () => removeFile(index);

        fileItem.appendChild(img);
        fileItem.appendChild(removeBtn);

        return fileItem;
      }

      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFilePreview();
        updateFileInput();
      }

      function updateFilePreview() {
        filePreview.innerHTML = "";

        if (selectedFiles.length === 0) {
          filePreview.style.display = "none";
          return;
        }

        filePreview.style.display = "flex";
        selectedFiles.forEach((file, index) => {
          filePreview.appendChild(createFilePreview(file, index));
        });
      }

      function updateFileInput() {
        // Create a new FileList-like object
        const dt = new DataTransfer();
        selectedFiles.forEach((file) => dt.items.add(file));
        imageInput.files = dt.files;
      }

      function updateProgress(percent) {
        progressBar.style.width = `${percent}%`;
      }

      async function uploadToNotion(files) {
        // Show progress bar
        uploadProgress.style.display = "block";
        updateProgress(0);

        try {
          // Convert files to base64 for direct upload
          const filePromises = files.map(async (file) => {
            return new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = () => {
                const base64Data = reader.result.split(",")[1]; // Remove data:image/...;base64, prefix
                console.log(`File ${file.name}:`, {
                  name: file.name,
                  type: file.type,
                  size: file.size,
                  dataLength: base64Data ? base64Data.length : 0,
                });
                resolve({
                  name: file.name,
                  type: file.type,
                  size: file.size,
                  data: base64Data,
                });
              };
              reader.readAsDataURL(file);
            });
          });

          updateProgress(25);
          const fileData = await Promise.all(filePromises);
          updateProgress(50);

          // Upload directly to Notion
          const res = await fetch(
            `${BASE_URL}.netlify/functions/upload-image`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                files: fileData,
              }),
            }
          );

          if (!res.ok) {
            let text;
            try {
              text = await res.text();
            } catch {
              text = res.statusText;
            }
            throw new Error("Upload failed: " + text);
          }

          updateProgress(75);

          const data = await res.json();
          console.log("Upload response:", data);

          if (!data.uploadedFiles || data.uploadedFiles.length === 0) {
            console.error("Upload failed - no successful uploads:", data);
            throw new Error("No files were successfully uploaded");
          }

          console.log("Successfully uploaded files:", data.uploadedFiles);
          console.log(
            "File structure for database:",
            data.uploadedFiles.map((f) => ({
              fileName: f.fileName,
              notionPage: f.notionPage,
              properties: f.notionPage?.properties,
            }))
          );

          updateProgress(100);

          // Return the Notion file objects for database integration
          // The upload function now returns an external file object per file
          return data.uploadedFiles.map((f) => {
            if (f.fileForNotion && f.fileForNotion.external?.url) {
              return f.fileForNotion;
            }
            return {
              name: f.fileName,
              type: "external",
              external: { url: f.publicUrl || "" },
            };
          });
        } catch (error) {
          console.error("Upload error:", error);
          throw error;
        } finally {
          // Hide progress bar after a delay
          setTimeout(() => {
            uploadProgress.style.display = "none";
            updateProgress(0);
          }, 1000);
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        showResult("Submitting…", true);

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const product = document.getElementById("product").value.trim();
        const serial = document.getElementById("serial").value.trim();
        const purchaseDate = document.getElementById("purchaseDate").value;
        const service = document.getElementById("service").value;
        const details = document.getElementById("details").value.trim();
        const scheduleDate = document.getElementById("scheduleDate").value;

        // Validate schedule date if provided
        if (scheduleDate) {
          const selectedDate = new Date(scheduleDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          if (selectedDate < today) {
            showResult(
              "Error: Please select a future date for engineer scheduling",
              false
            );
            submitBtn.disabled = false;
            return;
          }
        }

        const now = new Date();
        const dateReceived = now.toISOString().split("T")[0];

        let imageFiles = [];
        try {
          if (selectedFiles.length > 0) {
            showResult("Uploading images directly to Notion…", true);
            imageFiles = await uploadToNotion(selectedFiles);
          }

          const body = {
            properties: {
              "Full Name": { title: [{ text: { content: name } }] },
              Email: { email },
              Product: { rich_text: [{ text: { content: product } }] },
              "Serial Number": { rich_text: [{ text: { content: serial } }] },
              "Purchase Date": { date: { start: purchaseDate } },
              "Issue Details": {
                rich_text: [{ text: { content: details } }],
              },
              "Issue Type": { select: { name: service } },
              Status: { status: { name: "New" } },
              "Received Date": { date: { start: dateReceived } },
              ...(scheduleDate &&
                scheduleDate.trim() !== "" && {
                  "Schedule Date": { date: { start: scheduleDate } },
                }),
              ...(imageFiles.length > 0 && {
                "Image Upload": {
                  files: imageFiles,
                },
              }),
            },
          };

          // Log the data being sent (for debugging)
          console.log("Submitting service request with data:", {
            name,
            email,
            product,
            serial,
            purchaseDate,
            service,
            details,
            scheduleDate: scheduleDate || "Not specified",
            imageFiles: imageFiles.length,
          });

          const res = await fetch(
            `${BASE_URL}.netlify/functions/submit-to-notion?path=/v1/pages`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(body),
            }
          );

          if (!res.ok) {
            const errorText = await res.text();
            let errorData;
            try {
              errorData = JSON.parse(errorText);
            } catch {
              errorData = { error: errorText };
            }
            throw new Error(
              errorData.error || errorData.message || `HTTP ${res.status}`
            );
          }

          const text = await res.text();
          let data;
          try {
            data = JSON.parse(text);
          } catch {
            data = { raw: text };
          }

          if (data.error) throw new Error(data.error);

          showResult("Request submitted successfully!", true);
          form.reset();
          selectedFiles = [];
          updateFilePreview();
          // Clear the schedule date field specifically since it might not be reset by form.reset()
          document.getElementById("scheduleDate").value = "";
        } catch (err) {
          console.error("Submission error:", err);
          showResult(`Error: ${err.message}`, false);
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>

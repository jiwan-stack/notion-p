<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Warranty Service Request</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
    }
    .container {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .status {
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }
    h1 {
      color: #007bff;
    }
    label {
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Warranty Service Request</h1>
    <form id="service-form">
      <div>
        <label for="name">Full Name</label>
        <input id="name" name="name" type="text" required placeholder="Your full name" />
      </div>

      <div style="margin-top: 12px">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required placeholder="you@example.com" />
      </div>

      <div style="margin-top: 12px">
        <label for="product">Product Name</label>
        <input id="product" name="product" type="text" required placeholder="e.g. Washing Machine Model X" />
      </div>

      <div style="margin-top: 12px">
        <label for="serial">Serial Number</label>
        <input id="serial" name="serial" type="text" required placeholder="e.g. SN12345678" />
      </div>

      <div style="margin-top: 12px">
        <label for="purchaseDate">Purchase Date</label>
        <input id="purchaseDate" name="purchaseDate" type="date" required />
      </div>

      <div style="margin-top: 12px">
        <label for="service">Issue Type</label>
        <select id="service" name="service" required>
          <option value="" disabled selected>Select issue</option>
          <option value="Defective Part">Defective Part</option>
          <option value="Not Functioning">Not Functioning</option>
          <option value="Performance Issue">Performance Issue</option>
          <option value="Physical Damage (Covered)">Physical Damage (Covered)</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div style="margin-top: 12px">
        <label for="details">Issue Details</label>
        <textarea id="details" name="details" required placeholder="Describe the problem" rows="5"></textarea>
      </div>

      <!-- Updated: multiple images -->
      <div style="margin-top: 12px">
        <label for="image">Upload Images</label>
        <input id="image" name="image" type="file" accept="image/*" capture="environment" multiple />
      </div>

      <div style="margin-top: 16px">
        <button id="submitBtn" type="submit">Submit Warranty Request</button>
      </div>
    </form>
    <div id="result" class="status" style="display: none"></div>
  </div>

  <script>
    const CLIENT_DATABASE_ID = "24a30c0a61cd80869243f2beb52b019c";
    const BASE_URL= "https://notion-p.netlify.app/"
    const form = document.getElementById("service-form");
    const resultEl = document.getElementById("result");
    const submitBtn = document.getElementById("submitBtn");

    function showResult(message, ok) {
      resultEl.style.display = "block";
      resultEl.style.background = ok ? "#d4edda" : "#f8d7da";
      resultEl.style.color = ok ? "#155724" : "#721c24";
      resultEl.textContent = message;
    }

    async function uploadToNetlify(files) {
      const formData = new FormData();
      for (const file of files) {
        formData.append("file", file);
      }

      const res = await fetch(`${BASE_URL}.netlify/functions/upload-image`, {
        method: "POST",
        body: formData
      });

      if (!res.ok) {
        let text;
        try { text = await res.text(); } catch { text = res.statusText; }
        throw new Error("Upload failed: " + text);
      }

      const data = await res.json();
      if (!data.urls) throw new Error("Upload function did not return URLs");
      return data.urls;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      showResult("Submitting…", true);

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const product = document.getElementById("product").value.trim();
      const serial = document.getElementById("serial").value.trim();
      const purchaseDate = document.getElementById("purchaseDate").value;
      const service = document.getElementById("service").value;
      const details = document.getElementById("details").value.trim();
      const imageFiles = document.getElementById("image").files;

      const now = new Date();
      const dateReceived = now.toISOString().split("T")[0];
      const followUp = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000)
        .toISOString()
        .split("T")[0];

      let imageUrls = [];
      try {
        if (imageFiles.length > 0) {
          showResult("Uploading images…", true);
          imageUrls = await uploadToNetlify(imageFiles);
        }

        const body = {
          clientDatabaseId: CLIENT_DATABASE_ID,
          properties: {
            "Client Name": { title: [{ text: { content: name } }] },
            "Email": { email },
            "Product Name": { rich_text: [{ text: { content: product } }] },
            "Serial Number": { rich_text: [{ text: { content: serial } }] },
            "Purchase Date": { date: { start: purchaseDate } },
            "Project Details": { rich_text: [{ text: { content: details } }] },
            "Service Type": { select: { name: service } },
            "Budget Range": { select: { name: "Warranty" } },
            "Status": { status: { name: "New" } },
            "Date Received": { date: { start: dateReceived } },
            "Follow-up Date": { date: { start: followUp } },
            ...(imageUrls.length > 0 && {
              "Image Upload": {
                files: imageUrls.map((url, idx) => ({
                  name: imageFiles[idx].name,
                  external: { url }
                }))
              }
            }),
          },
        };

        const res = await fetch(`${BASE_URL}.netlify/functions/submit-to-notion?path=/v1/pages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const errorText = await res.text();
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch {
            errorData = { error: errorText };
          }
          throw new Error(errorData.error || errorData.message || `HTTP ${res.status}`);
        }

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = { raw: text };
        }

        if (data.error) throw new Error(data.error);

        showResult("Request submitted successfully!", true);
        form.reset();
      } catch (err) {
        console.error("Submission error:", err);
        showResult(`Error: ${err.message}`, false);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
